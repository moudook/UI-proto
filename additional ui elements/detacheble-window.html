<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meeting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 6px;
        }

        ::-webkit-scrollbar-thumb {
            background: #cbd5e1;
            border-radius: 3px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Panel Animation */
        .panel-hidden {
            opacity: 0;
            transform: translateY(-10px) scale(0.98);
            pointer-events: none;
            height: 0;
        }

        .panel-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            height: auto;
        }

        /* Audio Waveform Animation */
        @keyframes sound {
            0% {
                height: 4px;
            }

            50% {
                height: 100%;
            }

            100% {
                height: 4px;
            }
        }

        .bar {
            width: 3px;
            background-color: #374151;
            border-radius: 99px;
            animation: sound 0ms -800ms linear infinite alternate;
            height: 4px;
        }

        .mic-active .bar {
            animation-duration: 400ms;
        }

        .mic-muted .bar {
            height: 3px;
            animation: none;
            opacity: 0.3;
        }

        /* Fade in effect */
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(5px);
            }

            to {
                opacity: 1;
                transform: translateY(0);
            }
        }

        /* Transparent error block with red border */
        .error-block {
            background-color: transparent !important;
            border: 1px solid red !important;
        }
    </style>
</head>

<body class="bg-transparent flex flex-col items-center justify-start p-2 text-black">

    <!-- 1. TOP CONTROL BAR (draggable) -->
    <div class="z-50 flex items-center bg-white text-gray-600 rounded-full px-2 py-2 shadow-lg border border-gray-200 select-none gap-2"
        style="-webkit-app-region: drag;">

        <!-- Live Audio Visualizer -->
        <div id="audioVisualizer" class="mic-active flex items-center justify-center gap-1 w-12 h-8 px-2 mr-2">
            <div class="bar" style="animation-delay: -1.2s;"></div>
            <div class="bar" style="animation-delay: -2.4s;"></div>
            <div class="bar" style="animation-delay: -0.5s;"></div>
            <div class="bar" style="animation-delay: -3.1s;"></div>
        </div>

        <!-- Mute/Unmute Button -->
        <button id="micBtn"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-700 transition border border-gray-200"
            style="-webkit-app-region: no-drag;">
            <svg id="iconMicOn" xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
            <svg id="iconMicOff" class="hidden" xmlns="http://www.w3.org/2000/svg" width="18" height="18"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="1" y1="1" x2="23" y2="23" />
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12" />
                <line x1="15" y1="9.34" x2="15" y2="4a3 3 0 0 0-5.94-.6" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
        </button>

        <!-- Ask Button -->
        <button id="askBtn"
            class="flex items-center gap-2 px-4 py-2 rounded-full bg-gray-100 hover:bg-gray-200 text-gray-900 border border-gray-200 transition"
            style="-webkit-app-region: no-drag;">
            <span class="text-sm font-semibold">Ask</span>
            <div
                class="flex items-center gap-0.5 bg-white px-1.5 py-0.5 rounded text-xs text-gray-500 font-mono border border-gray-200">
                <span>âŒ˜</span>
                <span>K</span>
            </div>
        </button>

        <!-- End Meeting Button -->
        <button id="endMeetingBtn"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-red-50 hover:bg-red-500 text-red-500 hover:text-white transition border border-red-100 ml-1"
            style="-webkit-app-region: no-drag;" title="End Session">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"
                class="rotate-135">
                <path
                    d="M22 16.92v3a2 2 0 0 1-2.18 2 19.79 19.79 0 0 1-8.63-3.07 19.5 19.5 0 0 1-6-6 19.79 19.79 0 0 1-3.07-8.67A2 2 0 0 1 4.11 2h3a2 2 0 0 1 2 1.72 12.84 12.84 0 0 0 .7 2.81 2 2 0 0 1-.45 2.11L8.09 9.91a16 16 0 0 0 6 6l1.27-1.27a2 2 0 0 1 2.11-.45 12.84 12.84 0 0 0 2.81.7A2 2 0 0 1 22 16.92z" />
            </svg>
        </button>
    </div>

    <!-- 2. AI CONTENT WINDOW -->
    <div id="insightPanel"
        class="panel-hidden z-40 mt-4 w-[500px] bg-gray-100 bg-opacity-30 rounded-2xl shadow-2xl border border-gray-200 text-gray-800 overflow-hidden flex flex-col transition-all duration-300 origin-top ring-1 ring-black/5">

        <!-- Header -->
        <div class="flex justify-between items-center px-5 pt-4 pb-2 border-b border-gray-50">
            <h3 class="text-black font-semibold text-sm uppercase tracking-wider flex items-center gap-2">
                <span class="w-2 h-2 rounded-full bg-indigo-500 animate-pulse"></span>
                AI Insights
            </h3>
        </div>

        <!-- Dynamic Content Area -->
        <div id="aiContentContainer" class="px-5 pb-6 pt-4 max-h-[400px] min-h-[100px] overflow-y-auto">
            <!-- Content/Loading injected here -->
        </div>

        <!-- Input Footer -->
        <div class="px-5 py-3 bg-transparent border-t border-gray-100">
            <div
                class="flex items-center gap-3 bg-transparent border border-gray-200 rounded-lg px-3 py-1.5 shadow-sm focus-within:ring-2 focus-within:ring-indigo-100 transition">
                <div
                    class="w-6 h-6 rounded-full bg-gray-200 flex items-center justify-center text-gray-500 text-[10px] font-bold">
                    AI</div>
                <!-- MODIFICATION: Added an ID to the input field -->
                <input id="chatInput" type="text" placeholder="Ask a follow-up question..."
                    class="bg-transparent outline-none text-base text-black w-full placeholder-gray-400">
                <!-- MODIFICATION: Added an ID to the send button -->
                <button id="sendBtn" class="text-gray-400 hover:text-indigo-600 transition">
                    <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript -->
    <script>
        // DOM Elements
        const askBtn = document.getElementById('askBtn');
        const insightPanel = document.getElementById('insightPanel');
        const contentContainer = document.getElementById('aiContentContainer');
        const micBtn = document.getElementById('micBtn');
        const iconMicOn = document.getElementById('iconMicOn');
        const iconMicOff = document.getElementById('iconMicOff');
        const visualizer = document.getElementById('audioVisualizer');
        const endMeetingBtn = document.getElementById('endMeetingBtn');
        // NEW: Get the new DOM elements
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // State
        let isPanelOpen = false;
        let isMuted = false;
        let apiTimeout;

        // --- End Meeting Button (Stops audio, closes self, opens diff) ---
        endMeetingBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                // This single IPC message tells the main process to orchestrate:
                // 1. Stopping system audio recording
                // 2. Opening the diff window
                // 3. Closing this detachable window
                window.electronAPI.send('end-session-and-show-diff');
            }
        });

        // --- CORE LOGIC: API Fetch with 10s Timer ---
        async function runAIFetchLogic(query = null) {
            // 1. Show Loading UI (YouTube style skeleton)
            renderLoadingState();

            // 2. Clear any existing timeout from previous runs
            if (apiTimeout) {
                clearTimeout(apiTimeout);
            }

            // 3. Start the 10-second countdown
            apiTimeout = setTimeout(() => {
                console.log("API Timed out after 10 seconds");
                renderErrorState("Request timed out");
            }, 10000);

            try {
                // 4. Attempt to call the API
                let resultText;

                if (window.electronAPI) {
                    // MODIFICATION: Pass the query to the Electron API if it exists
                    resultText = await window.electronAPI.invoke('get-ai-insights', { query });
                } else {
                    // Standard Web Fetch simulation
                    // MODIFICATION: Pass the query in the body of the fetch request
                    const response = await fetch('/api/get-insights', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json',
                        },
                        body: JSON.stringify({ query }),
                    });

                    if (!response.ok) {
                        throw new Error(`Server status: ${response.status}`);
                    }
                    resultText = await response.text();
                }

                // 5. SUCCESS: If we reach here, the call worked.
                clearTimeout(apiTimeout); // Stop the 10s timer
                renderAIContent(resultText);

            } catch (error) {
                // 6. ERROR: If API fails immediately or network drops
                console.error(error);
                clearTimeout(apiTimeout);
                renderErrorState(error.message);
            }
        }

        // --- Global function for "Try Again" button ---
        window.retryFetch = function () {
            runAIFetchLogic();
        };

        // --- 1. ASK BUTTON (Trigger) ---
        askBtn.addEventListener('click', async () => {
            isPanelOpen = !isPanelOpen;

            if (isPanelOpen) {
                // Open Panel
                insightPanel.classList.remove('panel-hidden');
                insightPanel.classList.add('panel-visible');

                // Active Button Style
                askBtn.classList.remove('bg-gray-100', 'text-gray-900');
                askBtn.classList.add('bg-indigo-600', 'text-white', 'border-transparent', 'ring-2', 'ring-indigo-200');

                // Trigger the logic
                runAIFetchLogic();

            } else {
                // Cancel timeout if closing
                if (apiTimeout) clearTimeout(apiTimeout);

                // Close Panel
                insightPanel.classList.remove('panel-visible');
                insightPanel.classList.add('panel-hidden');

                // Revert Button Style
                askBtn.classList.add('bg-gray-100', 'text-gray-900');
                askBtn.classList.remove('bg-indigo-600', 'text-white', 'border-transparent', 'ring-2', 'ring-indigo-200');
            }
        });

        // --- 2. RENDER FUNCTIONS ---

        // YouTube-like skeleton loading
        function renderLoadingState() {
            contentContainer.innerHTML = `
                <div class="space-y-3 animate-pulse">
                    <div class="h-4 bg-gray-300 rounded w-3/4"></div>
                    <div class="h-4 bg-gray-300 rounded w-full"></div>
                    <div class="h-4 bg-gray-300 rounded w-full"></div>
                    <div class="h-4 bg-gray-300 rounded w-5/6"></div>
                    <div class="h-4 bg-gray-300 rounded w-1/2"></div>
                </div>
            `;
        }

        // RED Connection Error Block
        function renderErrorState(errorMessage = "Connection to main application failed") {
            contentContainer.innerHTML = `
                <div class="fade-in">
                    <div class="flex items-start gap-3 p-3 rounded-lg border border-red-500 shadow-sm">
                        <div class="flex-shrink-0 w-5 h-5 rounded-full flex items-center justify-center">
                            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="black" stroke-width="2" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-black">Connection Error</h4>
                            <p class="text-xs text-black mt-1">${errorMessage}. The main application may not be responding.</p>
                            <button onclick="window.retryFetch()" class="text-xs font-semibold text-black underline mt-2 hover:text-gray-700 cursor-pointer">Try Again</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAIContent(textChunk) {
            if (!textChunk) return;

            contentContainer.innerHTML = `
                <div class="fade-in">
                    <p class="text-black text-sm leading-relaxed whitespace-pre-line">${textChunk}</p>
                </div>
            `;
        }

        // --- 3. MIC TOGGLE LOGIC ---
        micBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            if (isMuted) {
                iconMicOn.classList.add('hidden');
                iconMicOff.classList.remove('hidden');
                micBtn.classList.add('bg-red-500', 'hover:bg-red-600', 'text-white', 'border-red-600');
                micBtn.classList.remove('bg.gray-100', 'text-gray-700');
                visualizer.classList.remove('mic-active');
                visualizer.classList.add('mic-muted');
            } else {
                iconMicOn.classList.remove('hidden');
                iconMicOff.classList.add('hidden');
                micBtn.classList.remove('bg-red-500', 'hover:bg-red-600', 'text-white', 'border-red-600');
                micBtn.classList.add('bg-gray-100', 'text-gray-700');
                visualizer.classList.add('mic-active');
                visualizer.classList.remove('mic-muted');
            }
        });

        // NEW: Function to handle sending a message from the input
        function handleSendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                // If the panel is not open, open it first
                if (!isPanelOpen) {
                }

                // Clear the input field
                chatInput.value = '';

                // Run the AI fetch logic with the user's message
                runAIFetchLogic(message);
            }
        }

        // NEW: Event listeners for the send button and Enter key
        sendBtn.addEventListener('click', handleSendMessage);

        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') {
                handleSendMessage();
            }
        });

        // --- Auto-resizing with ResizeObserver ---
        if (window.electronAPI) {
            const observer = new ResizeObserver(() => {
                const height = document.body.offsetHeight;
                const width = document.body.offsetWidth;
                window.electronAPI.send('resize-detachable-window', { width, height });
            });
            observer.observe(document.body);
        }
    </script>
</body>

</html>