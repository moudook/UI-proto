<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>AI Meeting Assistant</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }

        /* Custom Scrollbar */
        ::-webkit-scrollbar {
            width: 4px;
        }

        ::-webkit-scrollbar-thumb {
            background: #94a3b8;
            border-radius: 4px;
        }

        ::-webkit-scrollbar-track {
            background: transparent;
        }

        /* Panel Animation */
        .panel-hidden {
            opacity: 0;
            transform: translateY(-10px) scale(0.98);
            pointer-events: none;
            height: 0;
        }

        .panel-visible {
            opacity: 1;
            transform: translateY(0) scale(1);
            pointer-events: auto;
            height: auto;
        }

        /* Audio Waveform Animation */
        @keyframes sound {
            0% { height: 4px; }
            50% { height: 70%; }
            100% { height: 4px; }
        }

        .bar {
            width: 3px;
            /* Updated to match the green/active aesthetic */
            background-color: #10b981; 
            border-radius: 99px;
            animation: sound 0ms -800ms linear infinite alternate;
            height: 4px;
        }

        .mic-active .bar {
            animation-duration: 400ms;
        }

        .mic-muted .bar {
            height: 3px;
            background-color: #ef4444; /* Red when muted */
            animation: none;
            opacity: 0.5;
        }

        /* Fade in effect */
        .fade-in {
            animation: fadeIn 0.4s ease-out forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(5px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>

<!-- Body remains transparent as requested -->
<body class="bg-transparent flex flex-col items-center justify-start p-4 text-slate-800">

    <!-- 1. TOP CONTROL BAR (draggable) -->
    <!-- Aesthetic Update: White pill container with subtle shadow and border -->
    <div class="z-50 flex items-center bg-white/95 backdrop-blur-sm rounded-full p-1.5 shadow-[0_4px_20px_-4px_rgba(0,0,0,0.1)] border border-gray-100 select-none gap-2"
        style="-webkit-app-region: drag;">

        <!-- Mute/Unmute Button -->
        <!-- Aesthetic Update: Styled like the "D2C" (green) or "Deep-tech" (red) pills -->
        <button id="micBtn"
            class="group flex items-center justify-center gap-2 pl-3 pr-2 h-10 rounded-full bg-emerald-50 hover:bg-emerald-100 border border-emerald-200 text-emerald-600 transition-all duration-200"
            style="-webkit-app-region: no-drag;">
            
            <!-- Live Audio Visualizer -->
            <div id="audioVisualizer" class="mic-active flex items-center justify-center gap-0.5 h-6 w-auto">
                <div class="bar" style="animation-delay: -1.2s;"></div>
                <div class="bar" style="animation-delay: -2.4s;"></div>
                <div class="bar" style="animation-delay: -0.5s;"></div>
                <div class="bar" style="animation-delay: -3.1s;"></div>
            </div>

            <div class="w-px h-4 bg-emerald-200 mx-1"></div>

            <svg id="iconMicOn" xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24"
                fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <path d="M12 1a3 3 0 0 0-3 3v8a3 3 0 0 0 6 0V4a3 3 0 0 0-3-3z" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
            <svg id="iconMicOff" class="hidden" xmlns="http://www.w3.org/2000/svg" width="16" height="16"
                viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round"
                stroke-linejoin="round">
                <line x1="1" y1="1" x2="23" y2="23" />
                <path d="M9 9v3a3 3 0 0 0 5.12 2.12" />
                <line x1="15" y1="9.34" x2="15" y2="4a3 3 0 0 0-5.94-.6" />
                <path d="M19 10v2a7 7 0 0 1-14 0v-2" />
                <line x1="12" y1="19" x2="12" y2="23" />
                <line x1="8" y1="23" x2="16" y2="23" />
            </svg>
        </button>

        <!-- Ask Button -->
        <!-- Aesthetic Update: Styled like the "Custom" (blue) pill -->
        <button id="askBtn"
            class="flex items-center gap-2 px-5 h-10 rounded-full bg-blue-50 hover:bg-blue-100 text-blue-600 border border-blue-200 transition-all duration-200"
            style="-webkit-app-region: no-drag;">
            <svg xmlns="http://www.w3.org/2000/svg" width="16" height="16" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                <circle cx="12" cy="12" r="10"></circle>
                <line x1="12" y1="16" x2="12" y2="12"></line>
                <line x1="12" y1="8" x2="12.01" y2="8"></line>
            </svg>
            <span class="text-sm font-semibold">Ask AI</span>
            <div
                class="hidden md:flex items-center gap-0.5 bg-white/60 px-1.5 py-0.5 rounded text-[10px] text-blue-400 font-bold border border-blue-100 ml-1">
                <span>âŒ˜K</span>
            </div>
        </button>

        <!-- End Meeting Button -->
        <!-- Aesthetic Update: Styled like the "Deep-tech" (red) pill -->
        <button id="endMeetingBtn"
            class="flex items-center justify-center w-10 h-10 rounded-full bg-rose-50 hover:bg-rose-100 text-rose-600 border border-rose-200 transition-all duration-200"
            style="-webkit-app-region: no-drag;" title="End Session">
            <svg xmlns="http://www.w3.org/2000/svg" width="18" height="18" viewBox="0 0 24 24" fill="none"
                stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round"
                class="rotate-180">
                <path d="M18.36 6.64a9 9 0 1 1-12.73 0"></path>
                <line x1="12" y1="2" x2="12" y2="12"></line>
            </svg>
        </button>
    </div>

    <!-- 2. AI CONTENT WINDOW -->
    <!-- Aesthetic Update: Cleaner card look, less transparency, softer shadows -->
    <div id="insightPanel"
        class="panel-hidden z-40 mt-3 w-[500px] bg-white rounded-3xl shadow-[0_8px_30px_rgb(0,0,0,0.08)] border border-gray-100 overflow-hidden flex flex-col transition-all duration-300 origin-top">

        <!-- Header -->
        <div class="flex justify-between items-center px-6 pt-5 pb-3 bg-white">
            <h3 class="text-slate-800 font-bold text-sm tracking-tight flex items-center gap-2">
                <span class="flex h-2 w-2 relative">
                    <span class="animate-ping absolute inline-flex h-full w-full rounded-full bg-indigo-400 opacity-75"></span>
                    <span class="relative inline-flex rounded-full h-2 w-2 bg-indigo-500"></span>
                </span>
                AI Insights
            </h3>
        </div>

        <!-- Dynamic Content Area -->
        <div id="aiContentContainer" class="px-6 pb-6 max-h-[400px] min-h-[100px] overflow-y-auto bg-white">
            <!-- Content/Loading injected here -->
        </div>

        <!-- Input Footer -->
        <div class="px-4 py-4 bg-gray-50/50 border-t border-gray-100">
            <div
                class="flex items-center gap-2 bg-white border border-gray-200 rounded-full px-2 py-2 shadow-sm focus-within:ring-2 focus-within:ring-indigo-100 focus-within:border-indigo-200 transition-all">
                
                <div class="w-8 h-8 rounded-full bg-indigo-50 text-indigo-600 flex items-center justify-center">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <path d="M12 2a10 10 0 1 0 10 10 4 4 0 0 1-5-5 4 4 0 0 1-5-5"></path>
                    </svg>
                </div>

                <input id="chatInput" type="text" placeholder="Ask a follow-up..."
                    class="bg-transparent outline-none text-sm text-slate-700 w-full placeholder-slate-400 font-medium">
                
                <button id="sendBtn" class="p-2 rounded-full bg-indigo-600 text-white hover:bg-indigo-700 transition shadow-sm">
                    <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none"
                        stroke="currentColor" stroke-width="3" stroke-linecap="round" stroke-linejoin="round">
                        <line x1="22" y1="2" x2="11" y2="13"></line>
                        <polygon points="22 2 15 22 11 13 2 9 22 2"></polygon>
                    </svg>
                </button>
            </div>
        </div>
    </div>

    <!-- JavaScript (Functionality Unchanged) -->
    <script>
        // DOM Elements
        const askBtn = document.getElementById('askBtn');
        const insightPanel = document.getElementById('insightPanel');
        const contentContainer = document.getElementById('aiContentContainer');
        const micBtn = document.getElementById('micBtn');
        const iconMicOn = document.getElementById('iconMicOn');
        const iconMicOff = document.getElementById('iconMicOff');
        const visualizer = document.getElementById('audioVisualizer');
        const endMeetingBtn = document.getElementById('endMeetingBtn');
        const chatInput = document.getElementById('chatInput');
        const sendBtn = document.getElementById('sendBtn');

        // State
        let isPanelOpen = false;
        let isMuted = false;
        let apiTimeout;

        // --- End Meeting Button ---
        endMeetingBtn.addEventListener('click', () => {
            if (window.electronAPI) {
                window.electronAPI.send('end-session-and-show-diff');
            }
        });

        // --- CORE LOGIC: API Fetch with 10s Timer ---
        async function runAIFetchLogic(query = null) {
            renderLoadingState();
            if (apiTimeout) clearTimeout(apiTimeout);

            apiTimeout = setTimeout(() => {
                console.log("API Timed out after 10 seconds");
                renderErrorState("Request timed out");
            }, 10000);

            try {
                let resultText;
                if (window.electronAPI) {
                    resultText = await window.electronAPI.invoke('get-ai-insights', { query });
                } else {
                    const response = await fetch('/api/get-insights', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({ query }),
                    });
                    if (!response.ok) throw new Error(`Server status: ${response.status}`);
                    resultText = await response.text();
                }
                clearTimeout(apiTimeout);
                renderAIContent(resultText);

            } catch (error) {
                console.error(error);
                clearTimeout(apiTimeout);
                renderErrorState(error.message);
            }
        }

        window.retryFetch = function () {
            runAIFetchLogic();
        };

        // --- 1. ASK BUTTON (Trigger) ---
        askBtn.addEventListener('click', async () => {
            isPanelOpen = !isPanelOpen;

            if (isPanelOpen) {
                insightPanel.classList.remove('panel-hidden');
                insightPanel.classList.add('panel-visible');
                
                // Active State Styling (Blue Filled)
                askBtn.classList.remove('bg-blue-50', 'text-blue-600', 'border-blue-200');
                askBtn.classList.add('bg-blue-600', 'text-white', 'border-transparent', 'shadow-md');
                
                runAIFetchLogic();
            } else {
                if (apiTimeout) clearTimeout(apiTimeout);
                
                insightPanel.classList.remove('panel-visible');
                insightPanel.classList.add('panel-hidden');

                // Inactive State Styling (Blue Outline/Pastel)
                askBtn.classList.add('bg-blue-50', 'text-blue-600', 'border-blue-200');
                askBtn.classList.remove('bg-blue-600', 'text-white', 'border-transparent', 'shadow-md');
            }
        });

        // --- 2. RENDER FUNCTIONS ---
        function renderLoadingState() {
            contentContainer.innerHTML = `
                <div class="space-y-4 pt-2">
                    <div class="flex gap-3 items-center">
                         <div class="h-8 w-8 rounded-full bg-gray-100 animate-pulse"></div>
                         <div class="h-4 bg-gray-100 rounded w-1/3 animate-pulse"></div>
                    </div>
                    <div class="pl-11 space-y-2">
                        <div class="h-3 bg-gray-100 rounded w-full animate-pulse"></div>
                        <div class="h-3 bg-gray-100 rounded w-5/6 animate-pulse"></div>
                        <div class="h-3 bg-gray-100 rounded w-4/6 animate-pulse"></div>
                    </div>
                </div>
            `;
        }

        function renderErrorState(errorMessage = "Connection to main application failed") {
            contentContainer.innerHTML = `
                <div class="fade-in pt-2">
                    <div class="flex items-start gap-3 p-4 rounded-xl bg-red-50 border border-red-100">
                        <div class="flex-shrink-0 w-6 h-6 rounded-full bg-red-100 flex items-center justify-center text-red-500">
                            <svg xmlns="http://www.w3.org/2000/svg" width="14" height="14" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round">
                                <circle cx="12" cy="12" r="10"></circle>
                                <line x1="12" y1="8" x2="12" y2="12"></line>
                                <line x1="12" y1="16" x2="12.01" y2="16"></line>
                            </svg>
                        </div>
                        <div class="flex-1">
                            <h4 class="text-sm font-bold text-red-700">Unable to Connect</h4>
                            <p class="text-xs text-red-600 mt-1 leading-relaxed">${errorMessage}.</p>
                            <button onclick="window.retryFetch()" class="text-xs font-semibold text-red-700 underline mt-2 hover:text-red-900 cursor-pointer">Try Again</button>
                        </div>
                    </div>
                </div>
            `;
        }

        function renderAIContent(textChunk) {
            if (!textChunk) return;
            contentContainer.innerHTML = `
                <div class="fade-in">
                    <p class="text-slate-600 text-sm leading-7 whitespace-pre-line font-medium">${textChunk}</p>
                </div>
            `;
        }

        // --- 3. MIC TOGGLE LOGIC ---
        micBtn.addEventListener('click', () => {
            isMuted = !isMuted;
            if (isMuted) {
                // Muted UI
                iconMicOn.classList.add('hidden');
                iconMicOff.classList.remove('hidden');
                
                // Red Pill Style
                micBtn.classList.remove('bg-emerald-50', 'border-emerald-200', 'text-emerald-600', 'hover:bg-emerald-100');
                micBtn.classList.add('bg-red-50', 'border-red-200', 'text-red-600', 'hover:bg-red-100');
                
                visualizer.classList.remove('mic-active');
                visualizer.classList.add('mic-muted');
            } else {
                // Active UI
                iconMicOn.classList.remove('hidden');
                iconMicOff.classList.add('hidden');
                
                // Green Pill Style
                micBtn.classList.add('bg-emerald-50', 'border-emerald-200', 'text-emerald-600', 'hover:bg-emerald-100');
                micBtn.classList.remove('bg-red-50', 'border-red-200', 'text-red-600', 'hover:bg-red-100');
                
                visualizer.classList.add('mic-active');
                visualizer.classList.remove('mic-muted');
            }
        });

        // --- Chat Functions ---
        function handleSendMessage() {
            const message = chatInput.value.trim();
            if (message) {
                if (!isPanelOpen) {}
                chatInput.value = '';
                runAIFetchLogic(message);
            }
        }

        sendBtn.addEventListener('click', handleSendMessage);
        chatInput.addEventListener('keydown', (event) => {
            if (event.key === 'Enter') handleSendMessage();
        });

        // --- Resize Observer ---
        if (window.electronAPI) {
            const observer = new ResizeObserver(() => {
                const height = document.body.offsetHeight;
                const width = document.body.offsetWidth;
                window.electronAPI.send('resize-detachable-window', { width, height });
            });
            observer.observe(document.body);
        }
    </script>
</body>
</html>