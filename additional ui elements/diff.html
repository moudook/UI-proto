<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Smart Resizable Diff Editor</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            --bg-body: #F0F4F8;
            --bg-card: #FFFFFF;
            --border-color: #CBD5E1;

            --text-primary: #1E293B;
            --text-secondary: #64748B;

            /* Diff Colors */
            --del-bg: #FFF1F2;
            --del-border: #F43F5E;
            --del-text: #881337;

            --add-bg: #ECFDF5;
            --add-border: #10B981;
            --add-text: #064E3B;

            /* Accessible Button Colors */
            --btn-accept: #2563EB;
            /* Vibrant Blue */
            --btn-reject: #475569;
            /* Slate Gray */
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 0;
            font-family: 'Inter', sans-serif;
            background-color: transparent;
            height: 100vh;
            overflow: hidden;
        }

        /* --- Main Card Container --- */
        .diff-card {
            background: var(--bg-card);

            /* SIZE LOGIC: */
            width: 100%;
            height: 100%;

            /* 2. Don't get smaller than this */
            min-height: 300px;
            min-width: 500px;

            /* 4. Allow user resizing */
            resize: both;
            overflow: hidden;
            /* Necessary for resize handle */

            border-radius: 12px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            border: 1px solid var(--border-color);

            display: flex;
            flex-direction: column;
            position: relative;
        }

        /* Header */
        .card-header {
            padding: 12px 20px;
            border-bottom: 1px solid var(--border-color);
            background: #F8FAFC;
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-shrink: 0;
            /* Prevents header from shrinking when scrolling */
            -webkit-app-region: drag;
        }

        .header-title {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-secondary);
        }

        /* Progress indicator */
        .progress-indicator {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 12px;
            color: var(--text-secondary);
        }

        .progress-indicator .current {
            font-weight: 600;
            color: var(--text-primary);
        }

        /* --- Window Controls --- */
        .window-controls {
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .window-control-btn {
            width: 28px;
            height: 28px;
            border-radius: 50%;
            border: none;
            background-color: #E5E7EB;
            color: #4B5563;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: background-color 0.2s, color 0.2s;
            -webkit-app-region: no-drag;
        }

        .window-control-btn:hover {
            background-color: #D1D5DB;
        }

        .window-control-btn.btn-close {
            background-color: #FEE2E2;
            color: #EF4444;
        }

        .window-control-btn.btn-close:hover {
            background-color: #FECACA;
            color: #DC2626;
        }

        .window-control-btn i {
            font-size: 12px;
        }

        /* --- Editor Body (The scrollable area) --- */
        .editor-body {
            display: flex;
            /* Flex: 1 makes it fill available vertical space */
            flex: 1;
            /* Min-height: 0 is crucial for nested flex scrolling to work */
            min-height: 0;
            position: relative;
            background-color: #fff;
        }

        .pane {
            width: 50%;
            height: 100%;
            /* This enables the internal scroll if content exceeds container max-height */
            overflow-y: auto;
            /* Padding for bottom buttons */
            padding-bottom: 80px;
            padding-top: 10px;
        }

        .pane.left {
            border-right: 1px solid var(--border-color);
        }

        /* Scrollbar Styling */
        .pane::-webkit-scrollbar {
            width: 10px;
            height: 10px;
        }

        .pane::-webkit-scrollbar-thumb {
            background: #CBD5E0;
            border: 3px solid #fff;
            border-radius: 10px;
        }

        /* --- Code Rows --- */
        .code-row {
            display: flex;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 24px;
            min-height: 24px;
        }

        .line-num {
            width: 45px;
            text-align: right;
            padding-right: 12px;
            color: #94A3B8;
            user-select: none;
            font-size: 11px;
            flex-shrink: 0;
        }

        .line-content {
            flex-grow: 1;
            padding-left: 10px;
            padding-right: 10px;
            white-space: pre-wrap;
            color: var(--text-primary);
            outline: none;
            word-break: break-all;
            /* Prevent horizontal overflow issues */
        }

        .line-content:focus {
            background-color: #F1F5F9;
        }

        /* Diff Styles */
        .code-row.deletion {
            background-color: var(--del-bg);
        }

        .code-row.deletion .line-content {
            color: var(--del-text);
        }

        .code-row.deletion .line-content {
            border-left: 3px solid var(--del-border);
        }

        .code-row.addition {
            background-color: var(--add-bg);
        }

        .code-row.addition .line-content {
            color: var(--add-text);
        }

        .code-row.addition .line-content {
            border-left: 3px solid var(--add-border);
        }

        .code-row.spacer {
            background: repeating-linear-gradient(45deg, #F8FAFC, #F8FAFC 10px, #F1F5F9 10px, #F1F5F9 20px);
        }

        /* --- Floating Buttons --- */
        .floating-actions {
            position: absolute;
            bottom: 30px;
            right: 30px;
            display: flex;
            gap: 15px;
            z-index: 100;
            /* Ensures visibility over text */
            pointer-events: none;
            /* Allows clicking through the gap between buttons */
        }

        .action-btn {
            pointer-events: auto;
            /* Re-enable clicks on buttons */
            width: 54px;
            height: 54px;
            border-radius: 50%;
            border: none;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            color: white;
            cursor: pointer;
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.2), 0 2px 4px -1px rgba(0, 0, 0, 0.1);
            transition: transform 0.1s, box-shadow 0.1s;
        }

        .action-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.2);
        }

        .action-btn:active {
            transform: scale(0.95);
        }

        /* Blue for Accept */
        .btn-accept {
            background-color: var(--btn-accept);
        }

        /* Grey for Reject */
        .btn-reject {
            background-color: var(--btn-reject);
        }

        /* --- Loading State --- */
        .loading-overlay {
            position: absolute;
            top: 45px;
            /* Below header */
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(255, 255, 255, 0.9);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
            /* Below buttons (100) but above text */
            color: var(--text-secondary);
        }

        /* YouTube-style loading animation */
        .youtube-loader {
            position: relative;
            width: 80%;
            height: 4px;
            background-color: rgba(255, 0, 0, 0.2);
            border-radius: 2px;
            overflow: hidden;
        }

        .youtube-loader::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            height: 100%;
            width: 30%;
            background-color: #ff0000;
            border-radius: 2px;
            animation: youtube-loading 1.5s infinite ease-in-out;
        }

        @keyframes youtube-loading {
            0% {
                left: -30%;
            }

            100% {
                left: 100%;
            }
        }

        /* Error Overlay (replaces loader on failure) */
        .error-overlay {
            position: absolute;
            top: 45px;
            /* Below header */
            left: 0;
            right: 0;
            bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 60;
            color: #7f1d1d;
            pointer-events: auto;
        }

        .error-overlay .msg {
            background: rgba(255, 255, 255, 0.8);
            border: 1px solid rgba(220, 38, 38, 0.2);
            color: #7f1d1d;
            padding: 18px 24px;
            border-radius: 24px;
            box-shadow: 0 8px 20px rgba(0, 0, 0, 0.04);
            text-align: center;
            max-width: 520px;
        }

        .error-overlay button.retry {
            margin-top: 12px;
            background: #ef4444;
            color: white;
            padding: 8px 14px;
            border-radius: 8px;
            border: none;
            cursor: pointer;
        }
    </style>
</head>

<body>

    <div class="diff-card" id="mainCard">
        <!-- Header -->
        <div class="card-header">
            <span class="header-title" id="fileName">Review Changes</span>
            <div class="progress-indicator" style="-webkit-app-region: no-drag;">
                <span>Change</span>
                <span class="current" id="currentPair">1</span>
                <span>of</span>
                <span id="totalPairs">1</span>
            </div>

            <!-- Window Controls -->
            <div class="window-controls">
                <button id="minimizeBtn" class="window-control-btn" title="Minimize"><i
                        class="fa-solid fa-minus"></i></button>
                <button id="maximizeBtn" class="window-control-btn" title="Maximize"><i
                        class="fa-regular fa-square"></i></button>
                <button id="closeBtn" class="window-control-btn btn-close" title="Close"><i
                        class="fa-solid fa-xmark"></i></button>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loading-overlay">
            <div class="youtube-loader"></div>
        </div>

        <!-- Error overlay (initially hidden) -->
        <div id="errorOverlay" class="error-overlay" style="display:none;">
            <div class="msg">
                <div id="errorMessage" style="font-size:14px; font-weight:600;">Unable to connect to the API.</div>
                <div style="font-size:12px; color:#9CA3AF; margin-top:6px;">Please check your connection or try again.
                </div>
                <button class="retry" id="retryBtn">Try Again</button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="editor-body">
            <div class="pane left" id="leftPane"></div>
            <div class="pane right" id="rightPane"></div>
        </div>

        <!-- Buttons (Always Visible) -->
        <div class="floating-actions" style="-webkit-app-region: no-drag;">
            <!-- Reject (Grey) -->
            <button class="action-btn btn-reject" onclick="handleAction('reject')" aria-label="Reject">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <!-- Accept (Blue) -->
            <button class="action-btn btn-accept" onclick="handleAction('accept')" aria-label="Accept">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <script>
        const leftPane = document.getElementById('leftPane');
        const rightPane = document.getElementById('rightPane');
        const loader = document.getElementById('loader');
        const errorOverlay = document.getElementById('errorOverlay');
        const retryBtn = document.getElementById('retryBtn');
        const errorMessage = document.getElementById('errorMessage');
        const fileNameEl = document.getElementById('fileName');
        const currentPairEl = document.getElementById('currentPair');
        const totalPairsEl = document.getElementById('totalPairs');

        // Window control buttons
        const minimizeBtn = document.getElementById('minimizeBtn');
        const maximizeBtn = document.getElementById('maximizeBtn');
        const closeBtn = document.getElementById('closeBtn');

        // State for multiple diff pairs
        let diffPairs = [];
        let currentPairIndex = 0;
        let results = []; // Store accept/reject results

        // Current pair content
        let leftText = "";
        let rightText = "";

        // --- 2. LCS Diff Algorithm ---
        function computeDiff(original, modified) {
            const lines1 = original.split('\n');
            const lines2 = modified.split('\n');
            const n = lines1.length, m = lines2.length;
            const dp = Array(n + 1).fill(0).map(() => Array(m + 1).fill(0));

            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (lines1[i - 1] === lines2[j - 1]) dp[i][j] = dp[i - 1][j - 1] + 1;
                    else dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                }
            }

            let i = n, j = m;
            const leftRes = [], rightRes = [];

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && lines1[i - 1] === lines2[j - 1]) {
                    leftRes.unshift({ type: 'normal', content: lines1[i - 1], lineNum: i });
                    rightRes.unshift({ type: 'normal', content: lines2[j - 1], lineNum: j });
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    leftRes.unshift({ type: 'spacer', content: '', lineNum: '' });
                    rightRes.unshift({ type: 'addition', content: lines2[j - 1], lineNum: j });
                    j--;
                } else {
                    leftRes.unshift({ type: 'deletion', content: lines1[i - 1], lineNum: i });
                    rightRes.unshift({ type: 'spacer', content: '', lineNum: '' });
                    i--;
                }
            }
            return { left: leftRes, right: rightRes };
        }

        // --- 3. Render Logic ---
        function renderRow(item) {
            const row = document.createElement('div');
            row.className = `code-row ${item.type}`;

            const num = document.createElement('div');
            num.className = 'line-num';
            num.textContent = item.lineNum;

            const content = document.createElement('div');
            content.className = 'line-content';
            content.contentEditable = item.type !== 'spacer';
            content.spellcheck = false;
            content.innerText = item.content;

            content.addEventListener('input', debounce(updateData, 500));

            row.appendChild(num);
            row.appendChild(content);
            return row;
        }

        function render() {
            const scrollTop = leftPane.scrollTop; // Save scroll position
            const { left, right } = computeDiff(leftText, rightText);

            leftPane.innerHTML = '';
            rightPane.innerHTML = '';

            left.forEach(item => leftPane.appendChild(renderRow(item)));
            right.forEach(item => rightPane.appendChild(renderRow(item)));

            // Restore scroll position
            leftPane.scrollTop = scrollTop;
            rightPane.scrollTop = scrollTop;
        }

        // --- 4. Handlers ---
        function updateData() {
            const extract = (pane) => {
                return Array.from(pane.querySelectorAll('.code-row'))
                    .filter(r => !r.classList.contains('spacer'))
                    .map(r => r.querySelector('.line-content').innerText)
                    .join('\n');
            };
            leftText = extract(leftPane);
            rightText = extract(rightPane);
            render();
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function handleAction(type) {
            const card = document.getElementById('mainCard');
            // Flash color based on action
            const color = type === 'accept' ? 'rgba(37, 99, 235, 0.4)' : 'rgba(71, 85, 105, 0.4)';

            card.style.transition = "box-shadow 0.2s";
            card.style.boxShadow = `0 0 0 5px ${color}`;

            // Store the result
            results.push({
                index: currentPairIndex,
                action: type,
                pair: diffPairs[currentPairIndex]
            });

            setTimeout(() => {
                card.style.boxShadow = "0 25px 50px -12px rgba(0, 0, 0, 0.25)";
                console.log(`User clicked: ${type} for pair ${currentPairIndex + 1}`);

                // Move to next pair or close if done
                if (currentPairIndex < diffPairs.length - 1) {
                    currentPairIndex++;
                    loadCurrentPair();
                } else {
                    // All pairs processed - send results and close
                    finishAndClose();
                }
            }, 300);
        }

        function loadCurrentPair() {
            if (diffPairs.length === 0) return;

            const pair = diffPairs[currentPairIndex];
            leftText = pair.left || pair.leftText || pair.original || '';
            rightText = pair.right || pair.rightText || pair.modified || '';

            // Update header
            fileNameEl.textContent = pair.fileName || pair.file || `Change ${currentPairIndex + 1}`;
            currentPairEl.textContent = currentPairIndex + 1;
            totalPairsEl.textContent = diffPairs.length;

            render();
        }

        function finishAndClose() {
            // Send results back to main process
            if (window.electronAPI) {
                window.electronAPI.send('diff-results', results);
                window.electronAPI.send('show-main-window');
                window.electronAPI.send('close-diff-window');
            }
            console.log('All pairs processed:', results);
        }

        // --- 5. Sync Scroll ---
        // We use a flag to prevent infinite loop of scroll events
        let isSyncingLeft = false;
        let isSyncingRight = false;

        leftPane.addEventListener('scroll', function () {
            if (!isSyncingLeft) {
                isSyncingRight = true;
                rightPane.scrollTop = this.scrollTop;
            }
            isSyncingLeft = false;
        });

        rightPane.addEventListener('scroll', function () {
            if (!isSyncingRight) {
                isSyncingLeft = true;
                leftPane.scrollTop = this.scrollTop;
            }
            isSyncingRight = false;
        });

        // --- New: API fetch logic with 10s timeout and error handling ---
        async function fetchDiffData() {
            loader.style.display = 'flex';
            errorOverlay.style.display = 'none';
            leftPane.innerHTML = rightPane.innerHTML = '';

            const timeoutMs = 10000; // 10s
            let didTimeout = false;

            // Prefer electronIPC if available, otherwise use fetch
            try {
                let timer;
                const abortController = new AbortController();

                // In case native fetch is used, abort after timeout
                timer = setTimeout(() => {
                    didTimeout = true;
                    abortController.abort();
                }, timeoutMs);

                let result;
                if (window.electronAPI && typeof window.electronAPI.invoke === 'function') {
                    // Provide a Promise-based timeout wrapper for the electron invoke
                    result = await Promise.race([
                        window.electronAPI.invoke('get-diff-pairs'),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeoutMs))
                    ]);
                } else {
                    const res = await fetch('/api/diff', { signal: abortController.signal });
                    if (!res.ok) throw new Error(`Fetch error: ${res.statusText}`);
                    result = await res.json();
                }

                if (!result) throw new Error('Empty response');

                // Handle multiple pairs or single pair
                if (Array.isArray(result)) {
                    diffPairs = result;
                } else if (result.pairs && Array.isArray(result.pairs)) {
                    diffPairs = result.pairs;
                } else {
                    // Single pair - wrap in array
                    diffPairs = [{
                        left: result.left || result.leftText || result.leftContent || '',
                        right: result.right || result.rightText || result.rightContent || '',
                        fileName: result.fileName || result.file || 'review_changes.js'
                    }];
                }

                // Reset state
                currentPairIndex = 0;
                results = [];

                // Load first pair
                loadCurrentPair();

            } catch (err) {
                console.error('Error fetching diff data:', err);
                if (didTimeout || err.name === 'AbortError' || err.message === 'Timeout') {
                    showError("Request timed out after 10 seconds.");
                } else {
                    showError("Unable to connect to the API.");
                }
            } finally {
                loader.style.display = 'none';
            }
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorOverlay.style.display = 'flex';
        }

        retryBtn.addEventListener('click', () => {
            fetchDiffData();
        });

        // --- 6. Init ---
        function init() {
            if (window.electronAPI) {
                minimizeBtn.addEventListener('click', () => window.electronAPI.send('minimize-diff-window'));
                maximizeBtn.addEventListener('click', () => window.electronAPI.send('maximize-diff-window'));
                closeBtn.addEventListener('click', () => window.electronAPI.send('close-diff-window'));
            }

            // Start loader and attempt to fetch data; if unreachable, show error after 10s
            fetchDiffData();
        }

        init();

    </script>
</body>

</html>