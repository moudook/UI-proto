<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diff Editor</title>

    <!-- Fonts -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
    <!-- Font Awesome -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">

    <style>
        :root {
            /* Palette based on Reference Image */
            --bg-body: #F9FAFB;
            --bg-card: #FFFFFF;
            --border-subtle: #F3F4F6;
            --border-focus: #E5E7EB;

            --text-primary: #111827;
            --text-secondary: #6B7280;
            --text-tertiary: #9CA3AF;

            /* Diff Colors - Soft Pastel Style */
            /* Red (Deep-tech style) */
            --del-bg: #FEF2F2;
            --del-border: #FCA5A5;
            --del-text: #B91C1C;

            /* Green (D2C style) */
            --add-bg: #ECFDF5;
            --add-border: #6EE7B7;
            --add-text: #047857;

            /* Button Colors (Tag Style) */
            /* Blue (Custom style) */
            --btn-accept-bg: #EFF6FF;
            --btn-accept-text: #2563EB;
            --btn-accept-border: #BFDBFE;

            /* Red (Deep-tech style for Reject) */
            --btn-reject-bg: #FEF2F2;
            --btn-reject-text: #DC2626;
            --btn-reject-border: #FECACA;
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: 20px;
            font-family: 'Inter', sans-serif;
            background-color: transparent; /* Electron transparency */
            height: 100vh;
            overflow: hidden;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        /* --- Main Card Container --- */
        .diff-card {
            background: var(--bg-card);
            width: 100%;
            height: 100%;
            min-height: 300px;
            min-width: 500px;
            
            /* Modern aesthetics */
            border-radius: 20px;
            box-shadow: 0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01);
            border: 1px solid var(--border-focus);

            display: flex;
            flex-direction: column;
            position: relative;
            overflow: hidden; /* Clips children to rounded corners */
            resize: both;
        }

        /* --- Header --- */
        .card-header {
            padding: 20px 24px 16px 24px;
            background: #fff;
            display: flex;
            flex-direction: column;
            gap: 12px;
            flex-shrink: 0;
            -webkit-app-region: drag;
            border-bottom: 1px solid var(--border-subtle);
        }

        .header-top {
            display: flex;
            justify-content: space-between;
            align-items: center;
        }

        .header-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
            letter-spacing: -0.02em;
        }

        /* Progress Bar Container */
        .progress-container {
            width: 100%;
            display: flex;
            flex-direction: column;
            gap: 6px;
        }

        .progress-track {
            width: 100%;
            height: 6px;
            background-color: #F3F4F6;
            border-radius: 10px;
            overflow: hidden;
            -webkit-app-region: no-drag;
        }

        .progress-fill {
            height: 100%;
            background-color: #3B82F6; /* The blue from the reference */
            width: 0%; /* JS will update this */
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .progress-text {
            font-size: 12px;
            font-weight: 500;
            color: var(--text-secondary);
            display: flex;
            justify-content: space-between;
        }

        /* --- Editor Body --- */
        .editor-body {
            display: flex;
            flex: 1;
            min-height: 0;
            position: relative;
            background-color: #fff;
        }

        .pane {
            width: 50%;
            height: 100%;
            overflow-y: auto;
            padding-bottom: 90px; /* Space for floating buttons */
            padding-top: 16px;
        }

        .pane.left {
            border-right: 1px solid var(--border-subtle);
        }

        /* Scrollbar Styling - Minimalist */
        .pane::-webkit-scrollbar {
            width: 6px;
            height: 6px;
        }

        .pane::-webkit-scrollbar-track {
            background: transparent;
        }

        .pane::-webkit-scrollbar-thumb {
            background: #E5E7EB;
            border-radius: 3px;
        }
        .pane::-webkit-scrollbar-thumb:hover {
            background: #D1D5DB;
        }

        /* --- Code Rows --- */
        .code-row {
            display: flex;
            font-family: 'JetBrains Mono', monospace;
            font-size: 13px;
            line-height: 22px; /* Slightly tighter */
            min-height: 22px;
        }

        .line-num {
            width: 50px;
            text-align: right;
            padding-right: 16px;
            color: #D1D5DB; /* Very subtle line numbers */
            user-select: none;
            font-size: 11px;
            flex-shrink: 0;
            font-family: 'Inter', sans-serif; /* Cleaner numbers */
            font-variant-numeric: tabular-nums;
        }

        .line-content {
            flex-grow: 1;
            padding-left: 8px;
            padding-right: 12px;
            white-space: pre-wrap;
            color: var(--text-primary);
            word-break: break-all;
            border-left: 2px solid transparent; /* Placeholder for status bar */
        }

        /* Diff Styles */
        .code-row.deletion {
            background-color: var(--del-bg);
        }
        .code-row.deletion .line-content {
            color: var(--del-text);
            border-left-color: var(--del-border);
        }

        .code-row.addition {
            background-color: var(--add-bg);
        }
        .code-row.addition .line-content {
            color: var(--add-text);
            border-left-color: var(--add-border);
        }

        .code-row.spacer {
            /* Striped pattern for empty space */
            background-image: repeating-linear-gradient(
                -45deg,
                #FAFAFA,
                #FAFAFA 4px,
                #F3F4F6 4px,
                #F3F4F6 8px
            );
        }

        /* --- Floating Actions (Styled like tags) --- */
        .floating-actions {
            position: absolute;
            bottom: 30px;
            left: 50%;
            transform: translateX(-50%);
            display: flex;
            gap: 20px;
            z-index: 100;
            pointer-events: none;
            padding: 8px;
            border-radius: 50px;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(8px);
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1);
            border: 1px solid rgba(255,255,255,0.5);
        }

        .action-btn {
            pointer-events: auto;
            width: 56px;
            height: 56px;
            border-radius: 50%; /* Circle shape */
            border: 1px solid transparent;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 20px;
            cursor: pointer;
            transition: all 0.2s ease;
            background-color: white;
        }

        /* Reject: Red Theme (Deep-tech) */
        .btn-reject {
            background-color: var(--btn-reject-bg);
            color: var(--btn-reject-text);
            border-color: var(--btn-reject-border);
        }
        .btn-reject:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(220, 38, 38, 0.15);
            background-color: #FEE2E2;
        }

        /* Accept: Blue Theme (Custom) */
        .btn-accept {
            background-color: var(--btn-accept-bg);
            color: var(--btn-accept-text);
            border-color: var(--btn-accept-border);
        }
        .btn-accept:hover {
            transform: scale(1.05);
            box-shadow: 0 4px 12px rgba(37, 99, 235, 0.15);
            background-color: #DBEAFE;
        }

        /* --- Overlay States --- */
        .loading-overlay {
            position: absolute;
            top: 100px; left: 0; right: 0; bottom: 0;
            background: rgba(255, 255, 255, 0.8);
            backdrop-filter: blur(2px);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }

        .youtube-loader {
            position: relative;
            width: 200px;
            height: 4px;
            background-color: #E5E7EB;
            border-radius: 10px;
            overflow: hidden;
        }

        .youtube-loader::before {
            content: "";
            position: absolute;
            top: 0; left: 0; height: 100%; width: 30%;
            background-color: #3B82F6;
            border-radius: 10px;
            animation: youtube-loading 1.5s infinite ease-in-out;
        }

        @keyframes youtube-loading {
            0% { left: -30%; }
            100% { left: 100%; }
        }

        .error-overlay {
            position: absolute;
            top: 100px; left: 0; right: 0; bottom: 0;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-direction: column;
            z-index: 60;
            pointer-events: auto;
            background: rgba(255, 255, 255, 0.9);
        }

        .error-overlay .msg {
            background: #FEF2F2;
            border: 1px solid #FECACA;
            color: #991B1B;
            padding: 24px 32px;
            border-radius: 16px;
            text-align: center;
            max-width: 400px;
            box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.05);
        }

        .error-overlay button.retry {
            margin-top: 16px;
            background: #DC2626;
            color: white;
            padding: 10px 20px;
            border-radius: 50px;
            border: none;
            font-weight: 500;
            cursor: pointer;
            transition: opacity 0.2s;
        }
        .error-overlay button.retry:hover { opacity: 0.9; }

    </style>
</head>

<body>

    <div class="diff-card" id="mainCard">
        <!-- Modern Header -->
        <div class="card-header">
            <div class="header-top">
                <span class="header-title" id="fileName">Review Changes</span>
            </div>

            <!-- Progress Bar Logic -->
            <div class="progress-container" style="-webkit-app-region: no-drag;">
                <div class="progress-track">
                    <div class="progress-fill" id="progressFill"></div>
                </div>
                <div class="progress-text">
                    <span style="color:var(--text-primary); font-weight:600;">File <span id="currentPair">1</span></span>
                    <span>Total <span id="totalPairs">1</span></span>
                </div>
            </div>
        </div>

        <!-- Loader -->
        <div id="loader" class="loading-overlay">
            <div class="youtube-loader"></div>
        </div>

        <!-- Error overlay -->
        <div id="errorOverlay" class="error-overlay" style="display:none;">
            <div class="msg">
                <div id="errorMessage" style="font-size:15px; font-weight:600; margin-bottom:4px;">Connection Failed</div>
                <div style="font-size:13px; opacity:0.8;">Please check your connection and try again.</div>
                <button class="retry" id="retryBtn">Retry</button>
            </div>
        </div>

        <!-- Scrollable Content -->
        <div class="editor-body">
            <div class="pane left" id="leftPane"></div>
            <div class="pane right" id="rightPane"></div>
        </div>

        <!-- Centered Floating Buttons -->
        <div class="floating-actions" style="-webkit-app-region: no-drag;">
            <!-- Reject (Red Theme) -->
            <button class="action-btn btn-reject" onclick="handleAction('reject')" aria-label="Reject" title="Reject Change">
                <i class="fa-solid fa-xmark"></i>
            </button>
            <!-- Accept (Blue Theme) -->
            <button class="action-btn btn-accept" onclick="handleAction('accept')" aria-label="Accept" title="Accept Change">
                <i class="fa-solid fa-check"></i>
            </button>
        </div>
    </div>

    <script>
        const leftPane = document.getElementById('leftPane');
        const rightPane = document.getElementById('rightPane');
        const loader = document.getElementById('loader');
        const errorOverlay = document.getElementById('errorOverlay');
        const retryBtn = document.getElementById('retryBtn');
        const errorMessage = document.getElementById('errorMessage');
        const fileNameEl = document.getElementById('fileName');
        const currentPairEl = document.getElementById('currentPair');
        const totalPairsEl = document.getElementById('totalPairs');
        const progressFill = document.getElementById('progressFill'); // New visual progress

        // State for multiple diff pairs
        let diffPairs = [];
        let currentPairIndex = 0;
        let results = []; 

        // Current pair content
        let leftText = "";
        let rightText = "";

        // --- 2. LCS Diff Algorithm (Unchanged) ---
        function computeDiff(original, modified) {
            const lines1 = original.split('\n');
            const lines2 = modified.split('\n');
            const n = lines1.length, m = lines2.length;
            const dp = Array(n + 1).fill(0).map(() => Array(m + 1).fill(0));

            for (let i = 1; i <= n; i++) {
                for (let j = 1; j <= m; j++) {
                    if (lines1[i - 1] === lines2[j - 1]) dp[i][j] = dp[i - 1][j - 1] + 1;
                    else dp[i][j] = Math.max(dp[i - 1][j], dp[i][j - 1]);
                }
            }

            let i = n, j = m;
            const leftRes = [], rightRes = [];

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && lines1[i - 1] === lines2[j - 1]) {
                    leftRes.unshift({ type: 'normal', content: lines1[i - 1], lineNum: i });
                    rightRes.unshift({ type: 'normal', content: lines2[j - 1], lineNum: j });
                    i--; j--;
                } else if (j > 0 && (i === 0 || dp[i][j - 1] >= dp[i - 1][j])) {
                    leftRes.unshift({ type: 'spacer', content: '', lineNum: '' });
                    rightRes.unshift({ type: 'addition', content: lines2[j - 1], lineNum: j });
                    j--;
                } else {
                    leftRes.unshift({ type: 'deletion', content: lines1[i - 1], lineNum: i });
                    rightRes.unshift({ type: 'spacer', content: '', lineNum: '' });
                    i--;
                }
            }
            return { left: leftRes, right: rightRes };
        }

        // --- 3. Render Logic ---
        function renderRow(item) {
            const row = document.createElement('div');
            row.className = `code-row ${item.type}`;

            const num = document.createElement('div');
            num.className = 'line-num';
            num.textContent = item.lineNum;

            const content = document.createElement('div');
            content.className = 'line-content';
            content.contentEditable = item.type !== 'spacer';
            content.spellcheck = false;
            content.innerText = item.content;

            content.addEventListener('input', debounce(updateData, 500));

            row.appendChild(num);
            row.appendChild(content);
            return row;
        }

        function render() {
            const scrollTop = leftPane.scrollTop; 
            const { left, right } = computeDiff(leftText, rightText);

            leftPane.innerHTML = '';
            rightPane.innerHTML = '';

            left.forEach(item => leftPane.appendChild(renderRow(item)));
            right.forEach(item => rightPane.appendChild(renderRow(item)));

            leftPane.scrollTop = scrollTop;
            rightPane.scrollTop = scrollTop;
        }

        // --- 4. Handlers ---
        function updateData() {
            const extract = (pane) => {
                return Array.from(pane.querySelectorAll('.code-row'))
                    .filter(r => !r.classList.contains('spacer'))
                    .map(r => r.querySelector('.line-content').innerText)
                    .join('\n');
            };
            leftText = extract(leftPane);
            rightText = extract(rightPane);
            render();
        }

        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }

        function handleAction(type) {
            const card = document.getElementById('mainCard');
            // Subtle aesthetic border flash
            const color = type === 'accept' ? 'var(--add-border)' : 'var(--del-border)';

            card.style.transition = "box-shadow 0.2s, border-color 0.2s";
            card.style.borderColor = color;
            card.style.boxShadow = `0 0 0 4px ${type === 'accept' ? '#D1FAE5' : '#FEE2E2'}`;

            results.push({
                index: currentPairIndex,
                action: type,
                pair: diffPairs[currentPairIndex]
            });

            setTimeout(() => {
                // Reset styles
                card.style.borderColor = 'var(--border-focus)';
                card.style.boxShadow = "0 20px 25px -5px rgba(0, 0, 0, 0.05), 0 8px 10px -6px rgba(0, 0, 0, 0.01)";
                
                if (currentPairIndex < diffPairs.length - 1) {
                    currentPairIndex++;
                    loadCurrentPair();
                } else {
                    finishAndClose();
                }
            }, 300);
        }

        function loadCurrentPair() {
            if (diffPairs.length === 0) return;

            const pair = diffPairs[currentPairIndex];
            leftText = pair.left || pair.leftText || pair.original || '';
            rightText = pair.right || pair.rightText || pair.modified || '';

            fileNameEl.textContent = pair.fileName || pair.file || `Change ${currentPairIndex + 1}`;
            currentPairEl.textContent = currentPairIndex + 1;
            totalPairsEl.textContent = diffPairs.length;

            // Visual Progress Bar Update
            const percentage = ((currentPairIndex + 1) / diffPairs.length) * 100;
            progressFill.style.width = `${percentage}%`;

            render();
        }

        function finishAndClose() {
            if (window.electronAPI) {
                window.electronAPI.send('diff-results', results);
                window.electronAPI.send('show-main-window');
                window.electronAPI.send('close-diff-window');
            }
            console.log('All pairs processed:', results);
        }

        // --- 5. Sync Scroll ---
        let isSyncingLeft = false;
        let isSyncingRight = false;

        leftPane.addEventListener('scroll', function () {
            if (!isSyncingLeft) {
                isSyncingRight = true;
                rightPane.scrollTop = this.scrollTop;
            }
            isSyncingLeft = false;
        });

        rightPane.addEventListener('scroll', function () {
            if (!isSyncingRight) {
                isSyncingLeft = true;
                leftPane.scrollTop = this.scrollTop;
            }
            isSyncingRight = false;
        });

        // --- API & Init ---
        async function fetchDiffData() {
            loader.style.display = 'flex';
            errorOverlay.style.display = 'none';
            leftPane.innerHTML = rightPane.innerHTML = '';

            const timeoutMs = 10000;
            let didTimeout = false;

            try {
                let timer;
                const abortController = new AbortController();

                timer = setTimeout(() => {
                    didTimeout = true;
                    abortController.abort();
                }, timeoutMs);

                let result;
                if (window.electronAPI && typeof window.electronAPI.invoke === 'function') {
                    result = await Promise.race([
                        window.electronAPI.invoke('get-diff-pairs'),
                        new Promise((_, reject) => setTimeout(() => reject(new Error('Timeout')), timeoutMs))
                    ]);
                } else {
                    const res = await fetch('/api/diff', { signal: abortController.signal });
                    if (!res.ok) throw new Error(`Fetch error: ${res.statusText}`);
                    result = await res.json();
                }

                if (!result) throw new Error('Empty response');

                if (Array.isArray(result)) {
                    diffPairs = result;
                } else if (result.pairs && Array.isArray(result.pairs)) {
                    diffPairs = result.pairs;
                } else {
                    diffPairs = [{
                        left: result.left || result.leftText || result.leftContent || '',
                        right: result.right || result.rightText || result.rightContent || '',
                        fileName: result.fileName || result.file || 'review_changes.js'
                    }];
                }

                currentPairIndex = 0;
                results = [];
                loadCurrentPair();

            } catch (err) {
                console.error('Error fetching diff data:', err);
                if (didTimeout || err.name === 'AbortError' || err.message === 'Timeout') {
                    showError("Request timed out.");
                } else {
                    showError("Unable to connect to the API.");
                }
            } finally {
                loader.style.display = 'none';
            }
        }

        function showError(msg) {
            errorMessage.textContent = msg;
            errorOverlay.style.display = 'flex';
        }

        retryBtn.addEventListener('click', () => {
            fetchDiffData();
        });

        function init() {
            // Window controls logic removed as requested
            fetchDiffData();
        }

        init();

    </script>
</body>

</html>