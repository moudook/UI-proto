<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">

    <!-- SECURITY: Content Security Policy -->
    <meta http-equiv="Content-Security-Policy"
        content="default-src 'self'; style-src 'self' 'unsafe-inline' https://fonts.googleapis.com; font-src 'self' https://fonts.gstatic.com; script-src 'self' 'unsafe-inline';">

    <title>Adjustable Diff Editor</title>

    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">

    <style>
        :root {
            /* Theme Variables */
            --phi: 1.618;
            --base-size: 14px;
            --line-height: 24px;
            --border-radius: 10px;

            --bg-app: #F0F4F8;
            --bg-card: #FFFFFF;

            --text-primary: #102A43;
            --text-secondary: #627D98;

            /* Accessible Colors */
            --add-bg: #E6FFFA;
            --add-border: #319795;
            --add-text: #234E52;

            --del-bg: #FFF5F5;
            --del-border: #D53F8C;
            --del-text: #702459;

            --spacer-stripe: repeating-linear-gradient(45deg,
                    #F7F9FC,
                    #F7F9FC 10px,
                    #EDF2F7 10px,
                    #EDF2F7 12px);
        }

        * {
            box-sizing: border-box;
            outline: none;
        }

        body {
            margin: 0;
            padding: calc(20px * var(--phi));
            font-family: 'Inter', sans-serif;
            background-color: var(--bg-app);
            height: 100vh;
            display: flex;
            align-items: center;
            justify-content: center;
            color: var(--text-primary);
        }

        /* --- Editor Card (Adaptive Height) --- */
        .editor-card {
            background: var(--bg-card);
            border-radius: calc(var(--border-radius) * var(--phi));
            box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            width: 100%;
            max-width: 1600px;

            /* Height Logic: Shrink to fit content, but cap at 80vh */
            height: fit-content;
            max-height: 80vh;

            display: flex;
            flex-direction: column;
            overflow: hidden;
            border: 1px solid #DAE1E7;
            position: relative;
        }

        /* --- Split View Area --- */
        .split-view {
            display: flex;
            flex-grow: 1;
            /* Allow internal scrolling if content exceeds max-height */
            overflow-y: auto;
            min-height: 150px;
            /* Minimum visible area */
        }

        .pane {
            width: 50%;
            padding-top: 20px;
            padding-bottom: 20px;
            will-change: scroll-position;
        }

        .pane.left {
            border-right: 1px solid #DAE1E7;
        }

        /* Scrollbar Styling */
        .split-view::-webkit-scrollbar {
            width: 12px;
            height: 12px;
        }

        .split-view::-webkit-scrollbar-track {
            background: transparent;
        }

        .split-view::-webkit-scrollbar-thumb {
            background: #BCCCDC;
            border: 3px solid transparent;
            background-clip: padding-box;
            border-radius: 99px;
        }

        .split-view::-webkit-scrollbar-thumb:hover {
            background-color: #829AB1;
        }

        /* --- Footer (Action Buttons) --- */
        .editor-footer {
            flex-shrink: 0;
            padding: 16px 24px;
            background: #FAFBFC;
            border-top: 1px solid #DAE1E7;
            display: flex;
            justify-content: center;
            /* CHANGED: Centered Buttons */
            gap: 16px;
        }

        .btn {
            padding: 10px 48px;
            /* Wider buttons for better aesthetics */
            border-radius: 6px;
            font-weight: 600;
            font-size: 0.9rem;
            cursor: pointer;
            border: none;
            transition: transform 0.1s ease, opacity 0.2s;
            font-family: 'Inter', sans-serif;
        }

        .btn:active {
            transform: scale(0.98);
        }

        .btn-reject {
            background-color: var(--del-bg);
            color: var(--del-text);
            border: 1px solid var(--del-border);
        }

        .btn-reject:hover {
            background-color: #FFE3E3;
        }

        .btn-accept {
            background-color: var(--add-border);
            color: white;
            box-shadow: 0 1px 3px rgba(0, 0, 0, 0.1);
        }

        .btn-accept:hover {
            background-color: #285E61;
        }

        /* --- Code Rows --- */
        .code-container {
            min-height: 100%;
            outline: none;
            counter-reset: line;
        }

        .diff-row {
            display: flex;
            width: 100%;
            font-family: 'JetBrains Mono', monospace;
            font-size: var(--base-size);
            line-height: var(--line-height);
            position: relative;
        }

        .diff-row::before {
            content: attr(data-line);
            display: block;
            width: 65px;
            min-width: 65px;
            text-align: right;
            padding-right: 20px;
            font-family: 'JetBrains Mono', monospace;
            font-size: 11px;
            color: var(--text-secondary);
            user-select: none;
            cursor: default;
            opacity: 0.7;
        }

        .diff-row.addition {
            background-color: var(--add-bg);
        }

        .diff-row.addition .line-content {
            color: var(--add-text);
            font-weight: 500;
        }

        .diff-row.addition::before {
            content: "+ " attr(data-line);
            color: var(--add-border);
            font-weight: bold;
            opacity: 1;
        }

        .diff-row.addition .line-content::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--add-border);
        }

        .diff-row.deletion {
            background-color: var(--del-bg);
        }

        .diff-row.deletion .line-content {
            color: var(--del-text);
        }

        .diff-row.deletion::before {
            content: "- " attr(data-line);
            color: var(--del-border);
            font-weight: bold;
            opacity: 1;
        }

        .diff-row.deletion .line-content::after {
            content: '';
            position: absolute;
            left: 0;
            top: 0;
            bottom: 0;
            width: 4px;
            background-color: var(--del-border);
        }

        .diff-row.spacer {
            background: var(--spacer-stripe);
        }

        .diff-row.spacer::before {
            content: "";
        }

        .line-content {
            flex-grow: 1;
            padding-left: 10px;
            padding-right: 20px;
            white-space: pre-wrap;
            word-break: break-all;
            color: var(--text-primary);
            position: relative;
        }

        #warning-toast {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #D53F8C;
            color: white;
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 0.9rem;
            display: none;
            z-index: 1000;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
    </style>
</head>

<body>

    <div class="editor-card">
        <!-- Split View Area -->
        <div class="split-view" id="scrollContainer">
            <!-- Left Pane -->
            <div class="pane left" id="leftPane">
                <div id="leftContent" class="code-container" contenteditable="true" spellcheck="false"></div>
            </div>

            <!-- Right Pane -->
            <div class="pane right" id="rightPane">
                <div id="rightContent" class="code-container" contenteditable="true" spellcheck="false"></div>
            </div>
        </div>

        <!-- Footer Area -->
        <div class="editor-footer">
            <button class="btn btn-reject" onclick="resolveDiff('reject')">Reject Changes</button>
            <button class="btn btn-accept" onclick="resolveDiff('accept')">Accept Changes</button>
        </div>
    </div>

    <div id="warning-toast">Input too large: Truncated for performance.</div>

    <script>
        // --- Security & Config ---
        const MAX_LINES = 2000;
        const DEBOUNCE_MS = 50;

        // --- Initial State ---
        const initialOriginal = [
            "function calculateTotal(price, tax) {",
            "  const total = price + tax;",
            "  return total;",
            "}"
        ];

        const initialNew = [
            "function calculateTotal(price, tax, discount) {",
            "  // Added discount logic",
            "  const total = (price + tax) - discount;",
            "  return total;",
            "}"
        ];

        let state = {
            leftLines: [...initialOriginal],
            rightLines: [...initialNew]
        };

        const leftContainer = document.getElementById('leftContent');
        const rightContainer = document.getElementById('rightContent');
        const scrollContainer = document.getElementById('scrollContainer');
        const warningToast = document.getElementById('warning-toast');

        // --- Logic: LCS Algorithm ---
        function computeLCS(left, right) {
            if (left.length > MAX_LINES || right.length > MAX_LINES) return null;
            const m = left.length;
            const n = right.length;
            const C = Array(m + 1).fill(0).map(() => Array(n + 1).fill(0));

            for (let i = 1; i <= m; i++) {
                for (let j = 1; j <= n; j++) {
                    if (left[i - 1] === right[j - 1]) {
                        C[i][j] = C[i - 1][j - 1] + 1;
                    } else {
                        C[i][j] = Math.max(C[i][j - 1], C[i - 1][j]);
                    }
                }
            }
            return C;
        }

        function getAlignedRows(left, right) {
            if (left.length > MAX_LINES || right.length > MAX_LINES) {
                showWarning();
                return {
                    alignedLeft: left.slice(0, MAX_LINES).map((l, i) => ({ type: 'content', line: l, index: i })),
                    alignedRight: right.slice(0, MAX_LINES).map((l, i) => ({ type: 'content', line: l, index: i }))
                };
            }

            const C = computeLCS(left, right);
            let i = left.length;
            let j = right.length;

            const alignedLeft = [];
            const alignedRight = [];

            while (i > 0 || j > 0) {
                if (i > 0 && j > 0 && left[i - 1] === right[j - 1]) {
                    alignedLeft.unshift({ type: 'content', line: left[i - 1], index: i - 1 });
                    alignedRight.unshift({ type: 'content', line: right[j - 1], index: j - 1 });
                    i--; j--;
                } else if (j > 0 && (i === 0 || C[i][j - 1] >= C[i - 1][j])) {
                    alignedLeft.unshift({ type: 'spacer', line: '', index: -1 });
                    alignedRight.unshift({ type: 'addition', line: right[j - 1], index: j - 1 });
                    j--;
                } else {
                    alignedLeft.unshift({ type: 'deletion', line: left[i - 1], index: i - 1 });
                    alignedRight.unshift({ type: 'spacer', line: '', index: -1 });
                    i--;
                }
            }
            return { alignedLeft, alignedRight };
        }

        // --- DOM Creation ---
        function createRowHTML(item, side) {
            const div = document.createElement('div');

            let classes = ['diff-row'];
            if (item.type === 'deletion') classes.push('deletion');
            if (item.type === 'addition') classes.push('addition');
            if (item.type === 'spacer') classes.push('spacer');
            div.className = classes.join(' ');

            if (item.type !== 'spacer') {
                div.setAttribute('data-line', item.index + 1);
            } else {
                div.setAttribute('data-line', '');
                div.contentEditable = "false";
            }

            const contentDiv = document.createElement('div');
            contentDiv.className = 'line-content';
            contentDiv.textContent = item.line; // Secure text insertion
            contentDiv.dataset.side = side;

            if (item.type !== 'spacer') {
                contentDiv.dataset.index = item.index;
            }

            div.appendChild(contentDiv);
            return div;
        }

        function render() {
            const cursor = saveCursor();
            const { alignedLeft, alignedRight } = getAlignedRows(state.leftLines, state.rightLines);

            const fragmentLeft = document.createDocumentFragment();
            const fragmentRight = document.createDocumentFragment();

            for (let k = 0; k < alignedLeft.length; k++) {
                fragmentLeft.appendChild(createRowHTML(alignedLeft[k], 'left'));
                fragmentRight.appendChild(createRowHTML(alignedRight[k], 'right'));
            }

            leftContainer.innerHTML = '';
            rightContainer.innerHTML = '';

            leftContainer.appendChild(fragmentLeft);
            rightContainer.appendChild(fragmentRight);

            restoreCursor(cursor);
        }

        // --- Resolution Logic (Accept/Reject) ---
        function resolveDiff(action) {
            if (action === 'accept') {
                // User Accepted: We chose the RIGHT side
                alert("Changes Accepted: Proceeding with Modified Text.");
                console.log("Resulting Code:", state.rightLines.join('\n'));

                // Visual feedback (Flash Green)
                document.body.style.backgroundColor = "#E6FFFA";
                setTimeout(() => document.body.style.backgroundColor = "#F0F4F8", 300);
            } else {
                // User Rejected: We chose the LEFT side
                alert("Changes Rejected: Reverting to Original Text.");
                console.log("Resulting Code:", state.leftLines.join('\n'));

                // Visual feedback (Flash Red)
                document.body.style.backgroundColor = "#FFF5F5";
                setTimeout(() => document.body.style.backgroundColor = "#F0F4F8", 300);
            }
        }

        // --- Debounce ---
        function debounce(func, wait) {
            let timeout;
            return function (...args) {
                clearTimeout(timeout);
                timeout = setTimeout(() => func.apply(this, args), wait);
            };
        }
        const debouncedRender = debounce(() => render(), DEBOUNCE_MS);

        // --- Cursor ---
        function saveCursor() {
            const sel = window.getSelection();
            if (!sel.rangeCount) return null;
            let node = sel.getRangeAt(0).startContainer;
            while (node && (!node.classList || !node.classList.contains('line-content'))) {
                node = node.parentNode;
                if (!node || node === document.body) break;
            }
            if (!node || !node.dataset || node.contentEditable === "false") return null;
            return {
                side: node.dataset.side,
                index: parseInt(node.dataset.index),
                offset: sel.getRangeAt(0).startOffset
            };
        }

        function restoreCursor(saved) {
            if (!saved) return;
            const container = saved.side === 'left' ? leftContainer : rightContainer;
            const contentDivs = container.querySelectorAll('.line-content');
            let targetDiv = null;

            for (let div of contentDivs) {
                if (parseInt(div.dataset.index) === saved.index) {
                    targetDiv = div;
                    break;
                }
            }

            if (targetDiv) {
                targetDiv.focus();
                const sel = window.getSelection();
                const range = document.createRange();
                if (targetDiv.firstChild) {
                    const len = targetDiv.firstChild.length;
                    range.setStart(targetDiv.firstChild, Math.min(saved.offset, len));
                    range.setEnd(targetDiv.firstChild, Math.min(saved.offset, len));
                } else {
                    range.setStart(targetDiv, 0);
                    range.setEnd(targetDiv, 0);
                }
                sel.removeAllRanges();
                sel.addRange(range);
            } else {
                container.focus();
            }
        }

        function showWarning() {
            warningToast.style.display = 'block';
            setTimeout(() => warningToast.style.display = 'none', 3000);
        }

        // --- Event Handling ---
        function handleInput(e, side) {
            const container = side === 'left' ? leftContainer : rightContainer;
            if (container.querySelectorAll('.diff-row').length === 0 || e.target === container) {
                const newText = container.innerText;
                const newLines = newText.split(/\r?\n/);
                if (newLines.length > MAX_LINES) {
                    newLines.length = MAX_LINES;
                    showWarning();
                }
                if (side === 'left') state.leftLines = newLines;
                else state.rightLines = newLines;
                render();
                return;
            }
            if (e.target.classList.contains('line-content')) {
                const index = parseInt(e.target.dataset.index);
                const lines = side === 'left' ? state.leftLines : state.rightLines;
                lines[index] = e.target.textContent;
                debouncedRender();
            }
        }

        function handleKeydown(e, side) {
            const target = e.target;
            if (!target.classList.contains('line-content')) return;

            const index = parseInt(target.dataset.index);
            const lines = side === 'left' ? state.leftLines : state.rightLines;

            if (e.key === 'Enter') {
                e.preventDefault();
                if (lines.length >= MAX_LINES) { showWarning(); return; }

                const cursor = window.getSelection().getRangeAt(0).startOffset;
                const currentLine = lines[index];
                lines[index] = currentLine.slice(0, cursor);
                lines.splice(index + 1, 0, currentLine.slice(cursor));
                render();
                restoreCursor({ side, index: index + 1, offset: 0 });
            }

            if (e.key === 'Backspace') {
                const cursor = window.getSelection().getRangeAt(0).startOffset;
                if (cursor === 0 && index > 0) {
                    e.preventDefault();
                    const prevLen = lines[index - 1].length;
                    lines[index - 1] += lines[index];
                    lines.splice(index, 1);
                    render();
                    restoreCursor({ side, index: index - 1, offset: prevLen });
                }
            }
        }

        function handlePaste(e, side) {
            e.preventDefault();
            const text = (e.clipboardData || window.clipboardData).getData('text/plain');
            document.execCommand("insertText", false, text);
            handleInput({ target: window.getSelection().anchorNode.parentNode }, side);
        }

        ['input', 'keydown', 'paste'].forEach(evt => {
            leftContainer.addEventListener(evt, (e) => {
                if (evt === 'input') handleInput(e, 'left');
                if (evt === 'keydown') handleKeydown(e, 'left');
                if (evt === 'paste') handlePaste(e, 'left');
            });
            rightContainer.addEventListener(evt, (e) => {
                if (evt === 'input') handleInput(e, 'right');
                if (evt === 'keydown') handleKeydown(e, 'right');
                if (evt === 'paste') handlePaste(e, 'right');
            });
        });

        render();

    </script>
</body>

</html>